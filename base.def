Bootstrap: docker
From: centos:8

%runscript

%files

%environment
export CUDADIR=/usr/local/cuda-10.2
export OPENBLASDIR=/usr/local
export MAGMADIR=/usr/local/magma
export PATH="${CUDADIR}/bin:$PATH"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/local/lib"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${CUDADIR}/lib64"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${MAGMADIR}/lib"
export PYTHONPATH="${PYTHONPATH}:/base"

%labels

%post
dnf install -y gcc-c++ gcc-gfortran
dnf install -y epel-release
dnf install -y git wget bc
dnf install -y gdb valgrind
dnf install -y make bzip2 autoconf automake libtool curl make unzip
dnf install -y python3 python3-devel
dnf install -y openssl openssl-devel
dnf install -y boost boost-devel

# ========== CUDA Install ==========

dnf config-manager --add-repo http://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-rhel7.repo
dnf install -y cuda-command-line-tools-10-2 cuda-compiler-10-2 cuda-libraries-dev-10-2 libcublas10 libcublas-devel
export CUDADIR=/usr/local/cuda-10.2

# ========= Source Builds =========
mkdir /base
pushd /base
mkdir scratch

# ========== CMake =============

pushd scratch
wget https://github.com/Kitware/CMake/releases/download/v3.17.1/cmake-3.17.1.tar.gz
tar -xzf cmake-3.17.1.tar.gz
cd cmake-3.17.1
./configure
make -j$(nproc)
make install
popd

# ========== OpenBLAS ========

pushd scratch
wget https://github.com/xianyi/OpenBLAS/archive/v0.3.9.tar.gz
tar -xzf v0.3.9.tar.gz
cd OpenBLAS-0.3.9
make -j$(nproc) \
#TARGET=SKYLAKE
export OPENBLASDIR=/usr/local
make install PREFIX=${OPENBLASDIR}
popd

# ========== MAGMA =========

pushd scratch
wget http://icl.utk.edu/projectsfiles/magma/downloads/magma-2.5.3.tar.gz
tar -xzf magma-2.5.3.tar.gz
cd magma-2.5.3
mkdir build
cd build
cmake .. -DGPU_TARGET='Pascal Volta' -DBLA_VENDOR=OpenBLAS -DUSE_FORTRAN=OFF -DCMAKE_BUILD_TYPE=Release\
    -DCUDA_TOOLKIT_ROOT_DIR=${CUDADIR} -DLAPACK_LIBRARIES=${OPENBLASDIR}/lib/libopenblas.so
make lib -j$(nproc)
make sparse-lib -j$(nproc)
make install
popd

# ======== Eigen =========

pushd scratch
wget https://gitlab.com/libeigen/eigen/-/archive/3.3.7/eigen-3.3.7.tar.gz
tar -xzf eigen-3.3.7.tar.gz
mv eigen-3.3.7 ../eigen3
popd

# ========= Flat Buffers =======

pushd scratch
wget https://github.com/google/flatbuffers/archive/v1.12.0.tar.gz
tar -xzf v1.12.0.tar.gz
cd flatbuffers-1.12.0
mkdir build
cd build
cmake ..
make -j$(nproc)
make install
popd

# ======== Python Setup ========

python3 -m venv /base/python
source /base/python/bin/activate
pip install matplotlib numpy scipy pandas flatbuffers numba
deactivate

# ======== Cleanup ======

dnf clean all
rm -rf /var/cache/yum
rm -rf /base/scratch
