Bootstrap: localimage
From: ./base.sif

%runscript
mixer

%files
./src /src

%environment
export SHELL=/bin/bash
export SCRIPT_PATH=/src
export PATH=${PATH}:${SCRIPT_PATH}/build
export PYTHON_PATH=${PYTHON_PATH}:${SCRIPT_PATH}/build

%labels

%post
cd /src

mkdir build
cd build

PREFIX=
CMAKE=/usr/local/bin/cmake
CUDADIR=/usr/local/cuda-10.2

${PREFIX} ${CMAKE} .. -DCMAKE_BUILD_TYPE=Release -DEIGEN3_INCLUDE_DIR=/base/eigen3 \
    -DCUDA_TOOLKIT_ROOT_DIR=${CUDADIR} -DCMAKE_CUDA_COMPILER=${CUDADIR}/bin/nvcc \
#    -DDIAG_SINGLE_PRECISION=ON
${PREFIX} make VERBOSE=1 -j$(nproc)
${PREFIX} make install

cp -r flatbuff/SYKSchema /base
chmod -R 0775 /base/SYKSchema
